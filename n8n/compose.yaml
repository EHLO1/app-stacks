#-[ PROJECT NAME
name: "n8n"

#-[ SERVICES
services:
  # Postgres - SQL Database
  postgres:
    image: "postgres:${POSTGRES_IMAGE_TAG}"
    container_name: "postgres"
    environment:
      - "POSTGRES_USER=${POSTGRES_USER}"
      - "POSTGRES_PASSWORD=${POSTGRES_PASSWORD}"
      - "POSTGRES_DB=${POSTGRES_DB}"
      - "POSTGRES_NON_ROOT_USER=${POSTGRES_NON_ROOT_USER}"
      - "POSTGRES_NON_ROOT_PASSWORD=${POSTGRES_NON_ROOT_PASSWORD}"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready", "-h", "localhost", "-U", "${POSTGRES_USER}", "-d", "${POSTGRES_DB}"]
      interval: "5s"
      timeout: "5s"
      retries: "10"
    networks:
      - "private"
    restart: "unless-stopped"
    volumes:
      - "postgres.data:/var/lib/postgresql/data"
      - "./init-data.sh:/docker-entrypoint-initdb.d/init-data.sh"
  
  # n8n - No-Code/Low-Code Workflow Automation
  n8n:
    image: "docker.n8n.io/n8nio/n8n:${N8N_IMAGE_TAG}"
    container_name: "n8n"
    depends_on:
      postgres:
    env_file: "./.env"
    networks:
      - "cloudflare"
      - "private"
    restart: "unless-stopped"
    volumes:
      - "n8n.data:/home/node"

#-[ NETWORKS
networks:
  # Public / External Network (Cloudflare Tunnel)
  cloudflare:
    external: true
  # Storage / Backend Network (Not Accessible Externally)
  private:
    driver: "bridge"

#-[ VOLUMES
volumes:
  postgres.data:
  n8n.data:
